@model juezprueba.Models.Problema
@{
    ViewData["Title"] = "Casos de Prueba";
}

<div class="container mt-4">
    <h2 class="mb-4">Casos de prueba para el problema: <strong>@Model.Titulo</strong></h2>

    <!-- Formulario para agregar -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-plus-circle"></i> Agregar nuevo caso de prueba
        </div>
        <div class="card-body">
            <form asp-action="AgregarCasoDesdeProblema" method="post">
                <input type="hidden" name="ProblemaId" value="@Model.Id" />
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="Input" id="inputInput" placeholder="Input" required />
                            <label for="inputInput">Input</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="OutputEsperado" id="outputEsperado" placeholder="Output esperado" required />
                            <label for="outputEsperado">Output esperado</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar caso
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de casos -->
    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
            <i class="fas fa-list"></i> Lista de casos de prueba
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Input</th>
                        <th>Output Esperado</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var caso in Model.CasosDePrueba)
                    {
                        <tr id="fila-@caso.Id">
                            <td>@caso.Id</td>
                            <td>@caso.Input</td>
                            <td>@caso.OutputEsperado</td>
                            <td class="text-end">
                                <!-- Editar -->
                                <button class="btn btn-warning btn-sm me-2 editar-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editarModal"
                                        data-id="@caso.Id"
                                        data-input="@caso.Input"
                                        data-output="@caso.OutputEsperado">
                                    <i class="fas fa-edit"></i> Editar
                                </button>

                                <!-- Eliminar -->
                                <button class="btn btn-danger btn-sm eliminar-btn" data-id="@caso.Id">
                                    <i class="fas fa-trash-alt"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de edición -->
<div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form asp-action="EditarCasoDesdeProblema" method="post" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarModalLabel">Editar Caso de Prueba</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="Id" id="edit-id" />
                <input type="hidden" name="ProblemaId" value="@Model.Id" />
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="Input" id="edit-input" placeholder="Input" required />
                    <label for="edit-input">Input</label>
                </div>
                <div class="form-floating">
                    <input type="text" class="form-control" name="OutputEsperado" id="edit-output" placeholder="Output esperado" required />
                    <label for="edit-output">Output esperado</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Guardar cambios
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Eliminar
        document.querySelectorAll('.eliminar-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.dataset.id;
                if (confirm("¿Deseas eliminar este caso?")) {
                    fetch('/CasoDePrueba/EliminarDesdeVista', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: 'id=' + id
                    }).then(res => {
                        if (res.ok) {
                            document.getElementById('fila-' + id).remove();
                        } else {
                            alert("Error al eliminar");
                        }
                    });
                }
            });
        });

        // Rellenar modal al hacer clic en Editar
        const editarModal = document.getElementById('editarModal');
        editarModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button.getAttribute('data-id');
            const input = button.getAttribute('data-input');
            const output = button.getAttribute('data-output');

            document.getElementById('edit-id').value = id;
            document.getElementById('edit-input').value = input;
            document.getElementById('edit-output').value = output;
        });
    </script>
}
